!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("livekit-client")):"function"==typeof define&&define.amd?define(["exports","livekit-client"],t):t((e||self).client={},e.livekitClient)}(this,function(e,t){function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},o.apply(null,arguments)}function r(e){return r=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},r(e)}function i(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,s(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}function s(e,t){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},s(e,t)}function c(e){var t="function"==typeof Map?new Map:void 0;return c=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return function(e,t,n){if(a())return Reflect.construct.apply(null,arguments);var o=[null];o.push.apply(o,t);var r=new(e.bind.apply(e,o));return n&&s(r,n.prototype),r}(e,arguments,r(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),s(n,e)},c(e)}function u(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var l=new Uint8Array(0),d=/*#__PURE__*/function(){function e(e,t){var n=this,o=this,r=this;this.options=void 0,this.connection=void 0,this.lastInterruptTimestamp=0,this.mode="listening",this.status="connecting",this.volume=1,this.currentEventId=1,this.lastFeedbackEventId=0,this.canSendFeedback=!1,this.endSessionWithDetails=function(e){try{return"connected"!==o.status&&"connecting"!==o.status?Promise.resolve():(o.updateStatus("disconnecting"),Promise.resolve(o.handleEndSession()).then(function(){o.updateStatus("disconnected"),o.options.onDisconnect&&o.options.onDisconnect(e)}))}catch(e){return Promise.reject(e)}},this.onMessage=function(e){try{switch(e.type){case"interruption":return r.handleInterruption(e),Promise.resolve();case"agent_response":return r.handleAgentResponse(e),Promise.resolve();case"user_transcript":return r.handleUserTranscript(e),Promise.resolve();case"internal_tentative_agent_response":return r.handleTentativeAgentResponse(e),Promise.resolve();case"client_tool_call":var t=u(function(){return Promise.resolve(r.handleClientToolCall(e)).then(function(){})},function(t){r.onError("Unexpected error in client tool call handling: "+(t instanceof Error?t.message:String(t)),{clientToolName:e.client_tool_call.tool_name,toolCallId:e.client_tool_call.tool_call_id})});return Promise.resolve(t&&t.then?t.then(function(){}):void 0);case"audio":return r.handleAudio(e),Promise.resolve();case"vad_score":return r.handleVadScore(e),Promise.resolve();case"ping":return r.connection.sendMessage({type:"pong",event_id:e.ping_event.event_id}),Promise.resolve();case"mcp_tool_call":return r.handleMCPToolCall(e),Promise.resolve();case"mcp_connection_status":return r.handleMCPConnectionStatus(e),Promise.resolve();case"agent_tool_request":return r.handleAgentToolRequest(e),Promise.resolve();case"agent_tool_response":return r.handleAgentToolResponse(e),Promise.resolve();case"conversation_initiation_metadata":return r.handleConversationMetadata(e),Promise.resolve();case"asr_initiation_metadata":return r.handleAsrInitiationMetadata(e),Promise.resolve();case"agent_chat_response_part":return r.handleAgentChatResponsePart(e),Promise.resolve();case"error":return r.handleErrorEvent(e),Promise.resolve();default:return r.options.onDebug&&r.options.onDebug(e),Promise.resolve()}}catch(e){return Promise.reject(e)}},this.setVolume=function(e){n.volume=e.volume},this.options=e,this.connection=t,this.options.onConnect&&this.options.onConnect({conversationId:t.conversationId}),this.connection.onMessage(this.onMessage),this.connection.onDisconnect(this.endSessionWithDetails),this.connection.onModeChange(function(e){return n.updateMode(e)}),this.updateStatus("connected")}e.getFullOptions=function(e){var t,n=function(e){var t,n,o=(null!=(t=null==(n=e.overrides)?void 0:n.conversation)?t:{}).textOnly,r=e.textOnly;return"boolean"==typeof r?("boolean"==typeof o&&r!==o&&console.warn("Conflicting textOnly options provided: "+r+" via options.textOnly (will be used) and "+o+" via options.overrides.conversation.textOnly (will be ignored)"),r):"boolean"==typeof o?o:void 0}(e);return o({clientTools:{},onConnect:function(){},onDebug:function(){},onDisconnect:function(){},onError:function(){},onMessage:function(){},onAudio:function(){},onModeChange:function(){},onStatusChange:function(){},onCanSendFeedbackChange:function(){},onInterruption:function(){}},e,{textOnly:n,overrides:o({},e.overrides,{conversation:o({},null==(t=e.overrides)?void 0:t.conversation,{textOnly:n})})})};var t=e.prototype;return t.endSession=function(){return this.endSessionWithDetails({reason:"user"})},t.handleEndSession=function(){try{return this.connection.close(),Promise.resolve()}catch(e){return Promise.reject(e)}},t.updateMode=function(e){e!==this.mode&&(this.mode=e,this.options.onModeChange&&this.options.onModeChange({mode:e}))},t.updateStatus=function(e){e!==this.status&&(this.status=e,this.options.onStatusChange&&this.options.onStatusChange({status:e}))},t.updateCanSendFeedback=function(){var e=this.currentEventId!==this.lastFeedbackEventId;this.canSendFeedback!==e&&(this.canSendFeedback=e,this.options.onCanSendFeedbackChange&&this.options.onCanSendFeedbackChange({canSendFeedback:e}))},t.handleInterruption=function(e){e.interruption_event&&(this.lastInterruptTimestamp=e.interruption_event.event_id,this.options.onInterruption&&this.options.onInterruption({event_id:e.interruption_event.event_id}))},t.handleAgentResponse=function(e){this.options.onMessage&&this.options.onMessage({source:"ai",role:"agent",message:e.agent_response_event.agent_response})},t.handleUserTranscript=function(e){this.options.onMessage&&this.options.onMessage({source:"user",role:"user",message:e.user_transcription_event.user_transcript})},t.handleTentativeAgentResponse=function(e){this.options.onDebug&&this.options.onDebug({type:"tentative_agent_response",response:e.tentative_agent_response_internal_event.tentative_agent_response})},t.handleVadScore=function(e){this.options.onVadScore&&this.options.onVadScore({vadScore:e.vad_score_event.vad_score})},t.handleClientToolCall=function(e){try{var t=this;return Promise.resolve(function(){if(Object.prototype.hasOwnProperty.call(t.options.clientTools,e.client_tool_call.tool_name)){var n=u(function(){return Promise.resolve(t.options.clientTools[e.client_tool_call.tool_name](e.client_tool_call.parameters)).then(function(n){var o="object"==typeof n?JSON.stringify(n):String(n);t.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:o,is_error:!1})})},function(n){t.onError("Client tool execution failed with following error: "+(null==n?void 0:n.message),{clientToolName:e.client_tool_call.tool_name}),t.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:"Client tool execution failed: "+(null==n?void 0:n.message),is_error:!0})});if(n&&n.then)return n.then(function(){})}else{if(t.options.onUnhandledClientToolCall)return void t.options.onUnhandledClientToolCall(e.client_tool_call);t.onError("Client tool with name "+e.client_tool_call.tool_name+" is not defined on client",{clientToolName:e.client_tool_call.tool_name}),t.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:"Client tool with name "+e.client_tool_call.tool_name+" is not defined on client",is_error:!0})}}())}catch(e){return Promise.reject(e)}},t.handleAudio=function(e){},t.handleMCPToolCall=function(e){this.options.onMCPToolCall&&this.options.onMCPToolCall(e.mcp_tool_call)},t.handleMCPConnectionStatus=function(e){this.options.onMCPConnectionStatus&&this.options.onMCPConnectionStatus(e.mcp_connection_status)},t.handleAgentToolRequest=function(e){this.options.onAgentToolRequest&&this.options.onAgentToolRequest(e.agent_tool_request)},t.handleAgentToolResponse=function(e){"end_call"===e.agent_tool_response.tool_name&&this.endSessionWithDetails({reason:"agent",context:new CloseEvent("end_call",{reason:"Agent ended the call"})}),this.options.onAgentToolResponse&&this.options.onAgentToolResponse(e.agent_tool_response)},t.handleConversationMetadata=function(e){this.options.onConversationMetadata&&this.options.onConversationMetadata(e.conversation_initiation_metadata_event)},t.handleAsrInitiationMetadata=function(e){this.options.onAsrInitiationMetadata&&this.options.onAsrInitiationMetadata(e.asr_initiation_metadata_event)},t.handleAgentChatResponsePart=function(e){this.options.onAgentChatResponsePart&&this.options.onAgentChatResponsePart(e.text_response_part)},t.handleErrorEvent=function(e){var t=e.error_event.error_type,n=e.error_event.message||e.error_event.reason||"Unknown error";"max_duration_exceeded"!==t?this.onError("Server error: "+n,{errorType:t,code:e.error_event.code,debugMessage:e.error_event.debug_message,details:e.error_event.details}):this.endSessionWithDetails({reason:"error",message:n,context:new Event("max_duration_exceeded")})},t.onError=function(e,t){console.error(e,t),this.options.onError&&this.options.onError(e,t)},t.getId=function(){return this.connection.conversationId},t.isOpen=function(){return"connected"===this.status},t.setMicMuted=function(e){this.connection.setMicMuted(e)},t.getInputByteFrequencyData=function(){return l},t.getOutputByteFrequencyData=function(){return l},t.getInputVolume=function(){return 0},t.getOutputVolume=function(){return 0},t.sendFeedback=function(e){this.canSendFeedback?(this.connection.sendMessage({type:"feedback",score:e?"like":"dislike",event_id:this.currentEventId}),this.lastFeedbackEventId=this.currentEventId,this.updateCanSendFeedback()):console.warn(0===this.lastFeedbackEventId?"Cannot send feedback: the conversation has not started yet.":"Cannot send feedback: feedback has already been sent for the current response.")},t.sendContextualUpdate=function(e){this.connection.sendMessage({type:"contextual_update",text:e})},t.sendUserMessage=function(e){this.connection.sendMessage({type:"user_message",text:e})},t.sendUserActivity=function(){this.connection.sendMessage({type:"user_activity"})},t.sendMCPToolApprovalResult=function(e,t){this.connection.sendMessage({type:"mcp_tool_approval_result",tool_call_id:e,is_approved:t})},e}(),h=/*#__PURE__*/function(){function e(e){void 0===e&&(e={}),this.queue=[],this.disconnectionDetails=null,this.onDisconnectCallback=null,this.onMessageCallback=null,this.onModeChangeCallback=null,this.onDebug=void 0,this.onDebug=e.onDebug}var t=e.prototype;return t.debug=function(e){this.onDebug&&this.onDebug(e)},t.onMessage=function(e){this.onMessageCallback=e;var t=this.queue;this.queue=[],t.length>0&&queueMicrotask(function(){t.forEach(e)})},t.onDisconnect=function(e){this.onDisconnectCallback=e;var t=this.disconnectionDetails;t&&queueMicrotask(function(){e(t)})},t.onModeChange=function(e){this.onModeChangeCallback=e},t.updateMode=function(e){var t;null==(t=this.onModeChangeCallback)||t.call(this,e)},t.disconnect=function(e){var t;this.disconnectionDetails||(this.disconnectionDetails=e,null==(t=this.onDisconnectCallback)||t.call(this,e))},t.handleMessage=function(e){this.onMessageCallback?this.onMessageCallback(e):this.queue.push(e)},e}();function p(e){var t=e.split("_"),n=t[0],o=t[1];if(!["pcm","ulaw"].includes(n))throw new Error("Invalid format: "+e);var r=Number.parseInt(o);if(Number.isNaN(r))throw new Error("Invalid sample rate: "+o);return{format:n,sampleRate:r}}var m="0.14.0";function v(e){return!!e.type}var f="conversation_initiation_client_data";function g(e){var t,n,o,r,i,a,s,c,u,l={type:f};return e.overrides&&(l.conversation_config_override={agent:{prompt:null==(n=e.overrides.agent)?void 0:n.prompt,first_message:null==(o=e.overrides.agent)?void 0:o.firstMessage,language:null==(r=e.overrides.agent)?void 0:r.language},tts:{voice_id:null==(i=e.overrides.tts)?void 0:i.voiceId,speed:null==(a=e.overrides.tts)?void 0:a.speed,stability:null==(s=e.overrides.tts)?void 0:s.stability,similarity_boost:null==(c=e.overrides.tts)?void 0:c.similarityBoost},conversation:{text_only:null==(u=e.overrides.conversation)?void 0:u.textOnly}}),e.customLlmExtraBody&&(l.custom_llm_extra_body=e.customLlmExtraBody),e.dynamicVariables&&(l.dynamic_variables=e.dynamicVariables),e.userId&&(l.user_id=e.userId),null!=(t=e.overrides)&&t.client&&(l.source_info={source:e.overrides.client.source,version:e.overrides.client.version}),l}var _=/*#__PURE__*/function(e){function t(t,n){var o;return(o=e.call(this,t)||this).closeCode=void 0,o.closeReason=void 0,o.name="SessionConnectionError",o.closeCode=null==n?void 0:n.closeCode,o.closeReason=null==n?void 0:n.closeReason,o}return i(t,e),t}(/*#__PURE__*/c(Error)),y=/*#__PURE__*/function(e){function t(t,n,o,r){var i;return(i=e.call(this)||this).socket=void 0,i.conversationId=void 0,i.inputFormat=void 0,i.outputFormat=void 0,i.socket=t,i.conversationId=n,i.inputFormat=o,i.outputFormat=r,i.socket.addEventListener("error",function(e){setTimeout(function(){return i.disconnect({reason:"error",message:"The connection was closed due to a socket error.",context:e})},0)}),i.socket.addEventListener("close",function(e){i.disconnect(1e3===e.code?{reason:"agent",context:e,closeCode:e.code,closeReason:e.reason||void 0}:{reason:"error",message:e.reason||"The connection was closed by the server.",context:e,closeCode:e.code,closeReason:e.reason||void 0})}),i.socket.addEventListener("message",function(e){try{var t=JSON.parse(e.data);if(!v(t))return void i.debug({type:"invalid_event",message:"Received invalid socket event",data:e.data});i.handleMessage(t)}catch(t){i.debug({type:"parsing_error",message:"Failed to parse socket message",error:t instanceof Error?t.message:String(t),data:e.data})}}),i}i(t,e),t.create=function(e){try{var n=null;return Promise.resolve(function(o,r){try{var i=function(){var o,r,i,a,s=null!=(o=e.origin)?o:"wss://api.elevenlabs.io",c=(null==(r=e.overrides)||null==(r=r.client)?void 0:r.version)||m,u=(null==(i=e.overrides)||null==(i=i.client)?void 0:i.source)||"js_sdk";if(e.signedUrl){var l=e.signedUrl.includes("?")?"&":"?";a=""+e.signedUrl+l+"source="+u+"&version="+c}else a=s+"/v1/convai/conversation?agent_id="+e.agentId+"&source="+u+"&version="+c;var d=["convai"];return e.authorization&&d.push("bearer."+e.authorization),n=new WebSocket(a,d),Promise.resolve(new Promise(function(t,o){n.addEventListener("open",function(){var t,o=g(e);null==(t=n)||t.send(JSON.stringify(o))},{once:!0}),n.addEventListener("error",function(e){setTimeout(function(){return o(new _("The connection was closed due to a socket error."))},0)}),n.addEventListener("close",function(e){o(new _(e.reason||(1e3===e.code?"Connection closed normally before session could be established.":"Connection closed unexpectedly before session could be established."),{closeCode:e.code,closeReason:e.reason||void 0}))}),n.addEventListener("message",function(e){var n=JSON.parse(e.data);v(n)&&("conversation_initiation_metadata"===n.type?t(n.conversation_initiation_metadata_event):console.warn("First received message is not conversation metadata."))},{once:!0})})).then(function(e){var o=e.conversation_id,r=e.agent_output_audio_format,i=e.user_input_audio_format,a=p(null!=i?i:"pcm_16000"),s=p(r);return new t(n,o,a,s)})}()}catch(e){return r(e)}return i&&i.then?i.then(void 0,r):i}(0,function(e){var t;throw null==(t=n)||t.close(),e}))}catch(e){return Promise.reject(e)}};var n=t.prototype;return n.close=function(){this.socket.close(1e3,"User ended conversation")},n.sendMessage=function(e){this.socket.send(JSON.stringify(e))},n.setMicMuted=function(e){try{return console.warn("WebSocket connection setMicMuted called with "+e+", but this is handled by VoiceConversation"),Promise.resolve()}catch(e){return Promise.reject(e)}},t}(h);function b(e){var t=new Uint8Array(e);return window.btoa(String.fromCharCode.apply(String,t))}function E(e){for(var t=window.atob(e),n=t.length,o=new Uint8Array(n),r=0;r<n;r++)o[r]=t.charCodeAt(r);return o.buffer}function S(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var w=new Map;function P(e,t){return function(n,o){try{var r,i=function(o){var i;if(r)return o;function a(o){return i?o:S(function(){var o="data:application/javascript;base64,"+btoa(t);return Promise.resolve(n.addModule(o)).then(function(){w.set(e,o)})},function(){throw new Error("Failed to load the "+e+" worklet module. Make sure the browser supports AudioWorklets. If you are using a strict CSP, you may need to self-host the worklet files.")})}var s=new Blob([t],{type:"application/javascript"}),c=URL.createObjectURL(s),u=S(function(){return Promise.resolve(n.addModule(c)).then(function(){w.set(e,c),i=1})},function(){URL.revokeObjectURL(c)});return u&&u.then?u.then(a):a(u)},a=w.get(e);if(a)return Promise.resolve(n.addModule(a));var s=function(){if(o)return S(function(){return Promise.resolve(n.addModule(o)).then(function(){w.set(e,o),r=1})},function(t){throw new Error("Failed to load the "+e+" worklet module from path: "+o+". Error: "+t)})}();return Promise.resolve(s&&s.then?s.then(i):i(s))}catch(e){return Promise.reject(e)}}}var C=P("rawAudioProcessor",'/*\n * ulaw encoding logic taken from the wavefile library\n * https://github.com/rochars/wavefile/blob/master/lib/codecs/mulaw.js\n * USED BY @elevenlabs/client\n */\n\nconst BIAS = 0x84;\nconst CLIP = 32635;\nconst encodeTable = [\n  0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,\n  4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,\n  5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n  5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7\n];\n\nfunction encodeSample(sample) {\n  let sign;\n  let exponent;\n  let mantissa;\n  let muLawSample;\n  sign = (sample >> 8) & 0x80;\n  if (sign !== 0) sample = -sample;\n  sample = sample + BIAS;\n  if (sample > CLIP) sample = CLIP;\n  exponent = encodeTable[(sample>>7) & 0xFF];\n  mantissa = (sample >> (exponent+3)) & 0x0F;\n  muLawSample = ~(sign | (exponent << 4) | mantissa);\n  \n  return muLawSample;\n}\n\nclass RawAudioProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n              \n    this.port.onmessage = ({ data }) => {\n      switch (data.type) {\n        case "setFormat":\n          this.isMuted = false;\n          this.buffer = []; // Initialize an empty buffer\n          this.bufferSize = data.sampleRate / 10;\n          this.format = data.format;\n\n          if (globalThis.LibSampleRate && sampleRate !== data.sampleRate) {\n            globalThis.LibSampleRate.create(1, sampleRate, data.sampleRate).then(resampler => {\n              this.resampler = resampler;\n            });\n          }\n          break;\n        case "setMuted":\n          this.isMuted = data.isMuted;\n          break;\n      }\n    };\n  }\n  process(inputs) {\n    if (!this.buffer) {\n      return true;\n    }\n    \n    const input = inputs[0]; // Get the first input node\n    if (input.length > 0) {\n      let channelData = input[0]; // Get the first channel\'s data\n\n      // Resample the audio if necessary\n      if (this.resampler) {\n        channelData = this.resampler.full(channelData);\n      }\n\n      // Add channel data to the buffer\n      this.buffer.push(...channelData);\n      // Get max volume \n      let sum = 0.0;\n      for (let i = 0; i < channelData.length; i++) {\n        sum += channelData[i] * channelData[i];\n      }\n      const maxVolume = Math.sqrt(sum / channelData.length);\n      // Check if buffer size has reached or exceeded the threshold\n      if (this.buffer.length >= this.bufferSize) {\n        const float32Array = this.isMuted \n          ? new Float32Array(this.buffer.length)\n          : new Float32Array(this.buffer);\n\n        let encodedArray = this.format === "ulaw"\n          ? new Uint8Array(float32Array.length)\n          : new Int16Array(float32Array.length);\n\n        // Iterate through the Float32Array and convert each sample to PCM16\n        for (let i = 0; i < float32Array.length; i++) {\n          // Clamp the value to the range [-1, 1]\n          let sample = Math.max(-1, Math.min(1, float32Array[i]));\n\n          // Scale the sample to the range [-32768, 32767]\n          let value = sample < 0 ? sample * 32768 : sample * 32767;\n          if (this.format === "ulaw") {\n            value = encodeSample(Math.round(value));\n          }\n\n          encodedArray[i] = value;\n        }\n\n        // Send the buffered data to the main script\n        this.port.postMessage([encodedArray, maxVolume]);\n\n        // Clear the buffer after sending\n        this.buffer = [];\n      }\n    }\n    return true; // Continue processing\n  }\n}\nregisterProcessor("rawAudioProcessor", RawAudioProcessor);\n');function k(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var R=/*#__PURE__*/function(e){function n(t,n,o,r,i){var a;return void 0===i&&(i={}),(a=e.call(this,i)||this).conversationId=void 0,a.inputFormat=void 0,a.outputFormat=void 0,a.room=void 0,a.isConnected=!1,a.audioEventId=1,a.audioCaptureContext=null,a.audioElements=[],a.outputDeviceId=null,a.outputAnalyser=null,a.outputFrequencyData=null,a.room=t,a.conversationId=n,a.inputFormat=o,a.outputFormat=r,a.setupRoomEventListeners(),a}i(n,e),n.create=function(e){try{var o,r=function(r){var i=new t.Room;return k(function(){var r="room_"+Date.now(),a=p("pcm_48000"),s=p("pcm_48000"),c=new n(i,r,a,s,e);return Promise.resolve(i.connect(e.livekitUrl||"wss://livekit.rtc.elevenlabs.io",o)).then(function(){return Promise.resolve(new Promise(function(e){if(c.isConnected)e();else{var n=function(){i.off(t.RoomEvent.Connected,n),e()};i.on(t.RoomEvent.Connected,n)}})).then(function(){function t(){var t=g(e);return c.debug({type:f,message:t}),Promise.resolve(c.sendMessage(t)).then(function(){return c})}var n;i.name&&(c.conversationId=(null==(n=i.name.match(/(conv_[a-zA-Z0-9]+)/))?void 0:n[0])||i.name);var o=function(){if(!e.textOnly)return Promise.resolve(i.localParticipant.setMicrophoneEnabled(!0)).then(function(){})}();return o&&o.then?o.then(t):t()})})},function(e){return Promise.resolve(i.disconnect()).then(function(){throw e})})},i=function(){if(!("conversationToken"in e)||!e.conversationToken)return function(){if("agentId"in e&&e.agentId)return k(function(){var t,n,r,i=(null==(t=e.overrides)||null==(t=t.client)?void 0:t.version)||m,a=(null==(n=e.overrides)||null==(n=n.client)?void 0:n.source)||"js_sdk",s=function(e){return e.replace(/^wss:\/\//,"https://")}(null!=(r=e.origin)?r:"https://api.elevenlabs.io");return Promise.resolve(fetch(s+"/v1/convai/conversation/token?agent_id="+e.agentId+"&source="+a+"&version="+i)).then(function(e){if(!e.ok)throw new Error("ElevenLabs API returned "+e.status+" "+e.statusText);return Promise.resolve(e.json()).then(function(e){if(!(o=e.token))throw new Error("No conversation token received from API")})})},function(t){var n=t instanceof Error?t.message:String(t);throw t instanceof Error&&t.message.includes("401")&&(n="Your agent has authentication enabled, but no signed URL or conversation token was provided."),new Error("Failed to fetch conversation token for agent "+e.agentId+": "+n)});throw new Error("Either conversationToken or agentId is required for WebRTC connection")}();o=e.conversationToken}();return Promise.resolve(i&&i.then?i.then(r):r())}catch(e){return Promise.reject(e)}};var o=n.prototype;return o.setupRoomEventListeners=function(){var e=this,n=this,o=this,r=this;this.room.on(t.RoomEvent.Connected,function(){try{return n.isConnected=!0,console.info("WebRTC room connected"),Promise.resolve()}catch(e){return Promise.reject(e)}}),this.room.on(t.RoomEvent.Disconnected,function(t){e.isConnected=!1,e.disconnect({reason:"agent",context:new CloseEvent("close",{reason:null==t?void 0:t.toString()})})}),this.room.on(t.RoomEvent.ConnectionStateChanged,function(n){n===t.ConnectionState.Disconnected&&(e.isConnected=!1,e.disconnect({reason:"error",message:"LiveKit connection state changed to "+n,context:new Event("connection_state_changed")}))}),this.room.on(t.RoomEvent.DataReceived,function(t,n){try{var o=JSON.parse((new TextDecoder).decode(t));if("audio"===o.type)return;v(o)?e.handleMessage(o):console.warn("Invalid socket event received:",o)}catch(e){console.warn("Failed to parse incoming data message:",e),console.warn("Raw payload:",(new TextDecoder).decode(t))}}),this.room.on(t.RoomEvent.TrackSubscribed,function(e,n,r){try{var i=function(){if(e.kind===t.Track.Kind.Audio&&r.identity.includes("agent")){var n=function(){return a.style.display="none",document.body.appendChild(a),o.audioElements.push(a),1===o.audioElements.length&&(null==o.onDebug||o.onDebug({type:"audio_element_ready"})),Promise.resolve(o.setupAudioCapture(i)).then(function(){})},i=e,a=i.attach();a.autoplay=!0,a.controls=!1;var s=function(){if(o.outputDeviceId&&a.setSinkId){var e=k(function(){return Promise.resolve(a.setSinkId(o.outputDeviceId)).then(function(){})},function(e){console.warn("Failed to set output device for new audio element:",e)});if(e&&e.then)return e.then(function(){})}}();return s&&s.then?s.then(n):n()}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}),this.room.on(t.RoomEvent.ActiveSpeakersChanged,function(e){try{return r.updateMode(e.length>0&&e[0].identity.startsWith("agent")?"speaking":"listening"),Promise.resolve()}catch(e){return Promise.reject(e)}}),this.room.on(t.RoomEvent.ParticipantDisconnected,function(t){var n;null!=(n=t.identity)&&n.startsWith("agent")&&e.disconnect({reason:"agent",context:new CloseEvent("close",{reason:"agent disconnected"})})})},o.close=function(){if(this.isConnected){try{this.room.localParticipant.audioTrackPublications.forEach(function(e){e.track&&e.track.stop()})}catch(e){console.warn("Error stopping local tracks:",e)}this.audioCaptureContext&&(this.audioCaptureContext.close().catch(function(e){console.warn("Error closing audio capture context:",e)}),this.audioCaptureContext=null),this.audioElements.forEach(function(e){e.parentNode&&e.parentNode.removeChild(e)}),this.audioElements=[],this.room.disconnect()}},o.sendMessage=function(e){try{var t=this;if(!t.isConnected||!t.room.localParticipant)return console.warn("Cannot send message: room not connected or no local participant"),Promise.resolve();if("user_audio_chunk"in e)return Promise.resolve();var n=k(function(){var n=(new TextEncoder).encode(JSON.stringify(e));return Promise.resolve(t.room.localParticipant.publishData(n,{reliable:!0})).then(function(){})},function(n){t.debug({type:"send_message_error",message:{message:e,error:n}}),console.error("Failed to send message via WebRTC:",n)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},o.getRoom=function(){return this.room},o.setMicMuted=function(e){try{var n=this;if(!n.isConnected||!n.room.localParticipant)return console.warn("Cannot set microphone muted: room not connected or no local participant"),Promise.resolve();var o=n.room.localParticipant.getTrackPublication(t.Track.Source.Microphone);return Promise.resolve(null!=o&&o.track?k(function(){var t=e?Promise.resolve(o.track.mute()).then(function(){}):Promise.resolve(o.track.unmute()).then(function(){});if(t&&t.then)return t.then(function(){})},function(){return Promise.resolve(n.room.localParticipant.setMicrophoneEnabled(!e)).then(function(){})}):Promise.resolve(n.room.localParticipant.setMicrophoneEnabled(!e)).then(function(){}))}catch(e){return Promise.reject(e)}},o.setupAudioCapture=function(e){try{var t=this,n=k(function(){var n=new AudioContext;t.audioCaptureContext=n,t.outputAnalyser=n.createAnalyser(),t.outputAnalyser.fftSize=2048,t.outputAnalyser.smoothingTimeConstant=.8;var o=new MediaStream([e.mediaStreamTrack]),r=n.createMediaStreamSource(o);return r.connect(t.outputAnalyser),Promise.resolve(C(n.audioWorklet)).then(function(){var e=new AudioWorkletNode(n,"rawAudioProcessor");t.outputAnalyser.connect(e),e.port.postMessage({type:"setFormat",format:t.outputFormat.format,sampleRate:t.outputFormat.sampleRate}),e.port.onmessage=function(e){var n=e.data;if(n[1]>.01){var o=b(n[0].buffer),r=t.audioEventId++;t.handleMessage({type:"audio",audio_event:{audio_base_64:o,event_id:r}})}},r.connect(e)})},function(e){console.warn("Failed to set up audio capture:",e)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},o.setAudioVolume=function(e){this.audioElements.forEach(function(t){t.volume=e})},o.setAudioOutputDevice=function(e){try{var t=this;if(!("setSinkId"in HTMLAudioElement.prototype))throw new Error("setSinkId is not supported in this browser");var n=t.audioElements.map(function(t){try{return Promise.resolve(k(function(){return Promise.resolve(t.setSinkId(e)).then(function(){})},function(e){throw console.error("Failed to set sink ID for audio element:",e),e}))}catch(e){return Promise.reject(e)}});return Promise.resolve(Promise.all(n)).then(function(){t.outputDeviceId=e})}catch(e){return Promise.reject(e)}},o.setAudioInputDevice=function(e){try{var n=this;if(!n.isConnected||!n.room.localParticipant)throw new Error("Cannot change input device: room not connected or no local participant");return Promise.resolve(k(function(){function o(){return Promise.resolve(t.createLocalAudioTrack({deviceId:{exact:e},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:{ideal:1}})).then(function(e){return Promise.resolve(n.room.localParticipant.publishTrack(e,{name:"microphone",source:t.Track.Source.Microphone})).then(function(){})})}var r=n.room.localParticipant.getTrackPublication(t.Track.Source.Microphone),i=function(){if(null!=r&&r.track)return Promise.resolve(r.track.stop()).then(function(){return Promise.resolve(n.room.localParticipant.unpublishTrack(r.track)).then(function(){})})}();return i&&i.then?i.then(o):o()},function(e){function t(){throw e}console.error("Failed to change input device:",e);var o=k(function(){return Promise.resolve(n.room.localParticipant.setMicrophoneEnabled(!0)).then(function(){})},function(e){console.error("Failed to recover microphone after device switch error:",e)});return o&&o.then?o.then(t):t()}))}catch(e){return Promise.reject(e)}},o.getOutputByteFrequencyData=function(){return this.outputAnalyser?(null!=this.outputFrequencyData||(this.outputFrequencyData=new Uint8Array(this.outputAnalyser.frequencyBinCount)),this.outputAnalyser.getByteFrequencyData(this.outputFrequencyData),this.outputFrequencyData):null},n}(h),I=function(e){try{var t=function(e){return e.connectionType?e.connectionType:"conversationToken"in e&&e.conversationToken?"webrtc":"websocket"}(e);switch(t){case"websocket":return Promise.resolve(y.create(e));case"webrtc":return Promise.resolve(R.create(e));default:throw new Error("Unknown connection type: "+t)}}catch(e){return Promise.reject(e)}};function A(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}var M=function(e){void 0===e&&(e={default:0,android:3e3});try{var t,n=e.default;if(/android/i.test(navigator.userAgent))n=null!=(t=e.android)?t:n;else if(A()){var o;n=null!=(o=e.ios)?o:n}var r=function(){if(n>0)return Promise.resolve(new Promise(function(e){return setTimeout(e,n)})).then(function(){})}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},T=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return i(t,e),t.startSession=function(e){try{var n=d.getFullOptions(e);n.onStatusChange&&n.onStatusChange({status:"connecting"}),n.onCanSendFeedbackChange&&n.onCanSendFeedbackChange({canSendFeedback:!1}),n.onModeChange&&n.onModeChange({mode:"listening"}),n.onCanSendFeedbackChange&&n.onCanSendFeedbackChange({canSendFeedback:!1});var o=null;return Promise.resolve(function(r,i){try{var a=Promise.resolve(M(n.connectionDelay)).then(function(){return Promise.resolve(I(e)).then(function(e){return new t(n,o=e)})})}catch(e){return i(e)}return a&&a.then?a.then(void 0,i):a}(0,function(e){var t;throw n.onStatusChange&&n.onStatusChange({status:"disconnected"}),null==(t=o)||t.close(),e}))}catch(e){return Promise.reject(e)}},t}(d);function D(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var F={echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:{ideal:1}},O=/*#__PURE__*/function(){function e(e,t,n,o,r,i,a){var s=this;void 0===a&&(a=console.error),this.context=void 0,this.analyser=void 0,this.worklet=void 0,this.inputStream=void 0,this.mediaStreamSource=void 0,this.permissions=void 0,this.onError=void 0,this.settingInput=!1,this.handlePermissionsChange=function(){if("denied"===s.permissions.state)s.onError("Microphone permission denied");else if(!s.settingInput){var e,t=s.inputStream.getAudioTracks()[0],n=null!=(e=null==t?void 0:t.getSettings())?e:{};s.setInputDevice(n.deviceId).catch(function(e){s.onError("Failed to reset input device after permission change:",e)})}},this.context=e,this.analyser=t,this.worklet=n,this.inputStream=o,this.mediaStreamSource=r,this.permissions=i,this.onError=a,this.permissions.addEventListener("change",this.handlePermissionsChange)}e.create=function(t){var n=t.sampleRate,r=t.format,i=t.preferHeadphonesForIosDevices,a=t.inputDeviceId,s=t.workletPaths,c=t.libsampleratePath,u=t.onError;try{var l=null,d=null;return Promise.resolve(D(function(){function t(){function t(){return Promise.resolve(C(l.audioWorklet,null==s?void 0:s.rawAudioProcessor)).then(function(){var t=o({voiceIsolation:!0},h);return Promise.resolve(navigator.mediaDevices.getUserMedia({audio:t})).then(function(t){var o=l.createMediaStreamSource(d=t),i=new AudioWorkletNode(l,"rawAudioProcessor");return i.port.postMessage({type:"setFormat",format:r,sampleRate:n}),o.connect(p),p.connect(i),Promise.resolve(l.resume()).then(function(){return Promise.resolve(navigator.permissions.query({name:"microphone"})).then(function(t){return new e(l,p,i,d,o,t,u)})})})})}a&&(h.deviceId=e.getDeviceIdConstraint(a));var i=navigator.mediaDevices.getSupportedConstraints().sampleRate,p=(l=new window.AudioContext(i?{sampleRate:n}:{})).createAnalyser(),m=function(){if(!i)return Promise.resolve(l.audioWorklet.addModule(c||"https://cdn.jsdelivr.net/npm/@alexanderolsen/libsamplerate-js@2.1.2/dist/libsamplerate.worklet.js")).then(function(){})}();return m&&m.then?m.then(t):t()}var h=o({sampleRate:{ideal:n}},F),p=function(){if(A()&&i)return Promise.resolve(window.navigator.mediaDevices.enumerateDevices()).then(function(e){var t=e.find(function(e){return"audioinput"===e.kind&&["airpod","headphone","earphone"].find(function(t){return e.label.toLowerCase().includes(t)})});t&&(h.deviceId={ideal:t.deviceId})})}();return p&&p.then?p.then(t):t()},function(e){var t,n;throw null==(t=d)||t.getTracks().forEach(function(e){e.stop()}),null==(n=l)||n.close(),e}))}catch(e){return Promise.reject(e)}},e.getDeviceIdConstraint=function(e){if(e)return A()?{ideal:e}:{exact:e}};var t=e.prototype;return t.forgetInputStreamAndSource=function(){for(var e,t=function(e){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=function(e,t){if(e){if("string"==typeof e)return n(e,t);var o={}.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?n(e,t):void 0}}(e))){t&&(e=t);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this.inputStream.getTracks());!(e=t()).done;)e.value.stop();this.mediaStreamSource.disconnect()},t.close=function(){try{var e=this;return e.forgetInputStreamAndSource(),e.permissions.removeEventListener("change",e.handlePermissionsChange),Promise.resolve(e.context.close()).then(function(){})}catch(e){return Promise.reject(e)}},t.setMuted=function(e){this.worklet.port.postMessage({type:"setMuted",isMuted:e})},t.setInputDevice=function(t){try{var n=this;return Promise.resolve(function(r,i){try{var a=D(function(){if(n.settingInput)throw new Error("Input device is already being set");n.settingInput=!0;var r=o({},F);t&&(r.deviceId=e.getDeviceIdConstraint(t));var i=o({voiceIsolation:!0},r);return Promise.resolve(navigator.mediaDevices.getUserMedia({audio:i})).then(function(e){n.forgetInputStreamAndSource(),n.inputStream=e,n.mediaStreamSource=n.context.createMediaStreamSource(e),n.mediaStreamSource.connect(n.analyser)})},function(e){throw n.onError("Failed to switch input device:",e),e})}catch(e){return i(!0,e)}return a&&a.then?a.then(i.bind(null,!1),i.bind(null,!0)):i(!1,a)}(0,function(e,t){if(n.settingInput=!1,e)throw t;return t}))}catch(e){return Promise.reject(e)}},e}(),x=P("audioConcatProcessor",'/*\n * ulaw decoding logic taken from the wavefile library\n * https://github.com/rochars/wavefile/blob/master/lib/codecs/mulaw.js\n * USED BY @elevenlabs/client\n */\n\nconst decodeTable = [0,132,396,924,1980,4092,8316,16764];\n\nfunction decodeSample(muLawSample) {\n  let sign;\n  let exponent;\n  let mantissa;\n  let sample;\n  muLawSample = ~muLawSample;\n  sign = (muLawSample & 0x80);\n  exponent = (muLawSample >> 4) & 0x07;\n  mantissa = muLawSample & 0x0F;\n  sample = decodeTable[exponent] + (mantissa << (exponent+3));\n  if (sign !== 0) sample = -sample;\n\n  return sample;\n}\n\nclass AudioConcatProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n    this.buffers = []; // Initialize an empty buffer\n    this.cursor = 0;\n    this.currentBuffer = null;\n    this.wasInterrupted = false;\n    this.finished = false;\n    \n    this.port.onmessage = ({ data }) => {\n      switch (data.type) {\n        case "setFormat":\n          this.format = data.format;\n          break;\n        case "buffer":\n          this.wasInterrupted = false;\n          this.buffers.push(\n            this.format === "ulaw"\n              ? new Uint8Array(data.buffer)\n              : new Int16Array(data.buffer)\n          );\n          break;\n        case "interrupt":\n          this.wasInterrupted = true;\n          break;\n        case "clearInterrupted":\n          if (this.wasInterrupted) {\n            this.wasInterrupted = false;\n            this.buffers = [];\n            this.currentBuffer = null;\n          }\n      }\n    };\n  }\n  process(_, outputs) {\n    let finished = false;\n    const output = outputs[0][0];\n    for (let i = 0; i < output.length; i++) {\n      if (!this.currentBuffer) {\n        if (this.buffers.length === 0) {\n          finished = true;\n          break;\n        }\n        this.currentBuffer = this.buffers.shift();\n        this.cursor = 0;\n      }\n\n      let value = this.currentBuffer[this.cursor];\n      if (this.format === "ulaw") {\n        value = decodeSample(value);\n      }\n      output[i] = value / 32768;\n      this.cursor++;\n\n      if (this.cursor >= this.currentBuffer.length) {\n        this.currentBuffer = null;\n      }\n    }\n\n    if (this.finished !== finished) {\n      this.finished = finished;\n      this.port.postMessage({ type: "process", finished });\n    }\n\n    return true; // Continue processing\n  }\n}\n\nregisterProcessor("audioConcatProcessor", AudioConcatProcessor);\n'),L=/*#__PURE__*/function(){function e(e,t,n,o,r){this.context=void 0,this.analyser=void 0,this.gain=void 0,this.worklet=void 0,this.audioElement=void 0,this.context=e,this.analyser=t,this.gain=n,this.worklet=o,this.audioElement=r}e.create=function(t){var n=t.sampleRate,o=t.format,r=t.outputDeviceId,i=t.workletPaths;try{var a=null,s=null;return Promise.resolve(function(t,c){try{var u=function(){var t=(a=new AudioContext({sampleRate:n})).createAnalyser(),c=a.createGain();(s=new Audio).src="",s.load(),s.autoplay=!0,s.style.display="none",document.body.appendChild(s);var u=a.createMediaStreamDestination();return s.srcObject=u.stream,c.connect(t),t.connect(u),Promise.resolve(x(a.audioWorklet,null==i?void 0:i.audioConcatProcessor)).then(function(){var n=new AudioWorkletNode(a,"audioConcatProcessor");return n.port.postMessage({type:"setFormat",format:o}),n.connect(c),Promise.resolve(a.resume()).then(function(){function o(){return new e(a,t,c,n,s)}var i=function(){if(r&&s.setSinkId)return Promise.resolve(s.setSinkId(r)).then(function(){})}();return i&&i.then?i.then(o):o()})})}()}catch(e){return c(e)}return u&&u.then?u.then(void 0,c):u}(0,function(e){var t,n;function o(){throw e}null!=(t=s)&&t.parentNode&&s.parentNode.removeChild(s),null==(n=s)||n.pause();var r=function(){if(a&&"closed"!==a.state)return Promise.resolve(a.close()).then(function(){})}();return r&&r.then?r.then(o):o()}))}catch(e){return Promise.reject(e)}};var t=e.prototype;return t.setOutputDevice=function(e){try{if(!("setSinkId"in HTMLAudioElement.prototype))throw new Error("setSinkId is not supported in this browser");return Promise.resolve(this.audioElement.setSinkId(e||"")).then(function(){})}catch(e){return Promise.reject(e)}},t.close=function(){try{var e=this;return e.audioElement.parentNode&&e.audioElement.parentNode.removeChild(e.audioElement),e.audioElement.pause(),Promise.resolve(e.context.close()).then(function(){})}catch(e){return Promise.reject(e)}},e}();function U(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var j,N=/*#__PURE__*/function(e){function t(n,o,r,i,a){var s;return(s=e.call(this,n,o)||this).input=void 0,s.output=void 0,s.wakeLock=void 0,s.inputFrequencyData=void 0,s.outputFrequencyData=void 0,s.visibilityChangeHandler=null,s.onInputWorkletMessage=function(e){"connected"===s.status&&s.connection.sendMessage({user_audio_chunk:b(e.data[0].buffer)})},s.onOutputWorkletMessage=function(e){var t=e.data;"process"===t.type&&s.updateMode(t.finished?"listening":"speaking")},s.addAudioBase64Chunk=function(e){s.output.gain.gain.cancelScheduledValues(s.output.context.currentTime),s.output.gain.gain.value=s.volume,s.output.worklet.port.postMessage({type:"clearInterrupted"}),s.output.worklet.port.postMessage({type:"buffer",buffer:E(e)})},s.fadeOutAudio=function(){s.updateMode("listening"),s.output.worklet.port.postMessage({type:"interrupt"}),s.output.gain.gain.exponentialRampToValueAtTime(1e-4,s.output.context.currentTime+2),setTimeout(function(){s.output.gain.gain.value=s.volume,s.output.worklet.port.postMessage({type:"clearInterrupted"})},2e3)},s.calculateVolume=function(e){if(0===e.length)return 0;for(var t=0,n=0;n<e.length;n++)t+=e[n]/255;return(t/=e.length)<0?0:t>1?1:t},s.setVolume=function(e){var t=e.volume,n=Number.isFinite(t)?Math.min(1,Math.max(0,t)):1;s.volume=n,s.connection instanceof R?s.connection.setAudioVolume(n):s.output.gain.gain.value=n},s.input=r,s.output=i,s.wakeLock=a,s.input.worklet.port.onmessage=s.onInputWorkletMessage,s.output.worklet.port.onmessage=s.onOutputWorkletMessage,a&&(s.visibilityChangeHandler=function(){var e;"visible"===document.visibilityState&&null!=(e=s.wakeLock)&&e.released&&t.requestWakeLock().then(function(e){s.wakeLock=e})},document.addEventListener("visibilitychange",s.visibilityChangeHandler)),s}i(t,e),t.requestWakeLock=function(){try{var e,t=function(){if("wakeLock"in navigator)return U(function(){return Promise.resolve(navigator.wakeLock.request("screen")).then(function(t){return e=1,t})},function(){})}();return Promise.resolve(t&&t.then?t.then(function(t){return e?t:null}):e?t:null)}catch(e){return Promise.reject(e)}},t.startSession=function(e){try{var n,r=function(){return U(function(){return Promise.resolve(navigator.mediaDevices.getUserMedia({audio:!0})).then(function(n){return u=n,Promise.resolve(M(i.connectionDelay)).then(function(){return Promise.resolve(I(e)).then(function(n){return s=n,Promise.resolve(Promise.all([O.create(o({},s.inputFormat,{preferHeadphonesForIosDevices:e.preferHeadphonesForIosDevices,inputDeviceId:e.inputDeviceId,workletPaths:e.workletPaths,libsampleratePath:e.libsampleratePath})),L.create(o({},s.outputFormat,{outputDeviceId:e.outputDeviceId,workletPaths:e.workletPaths}))])).then(function(e){var n;return a=e[0],c=e[1],null==(n=u)||n.getTracks().forEach(function(e){e.stop()}),u=null,new t(i,s,a,c,h)})})})})},function(e){var t,n,o;return i.onStatusChange&&i.onStatusChange({status:"disconnected"}),null==(t=u)||t.getTracks().forEach(function(e){e.stop()}),null==(n=s)||n.close(),Promise.resolve(null==(o=a)?void 0:o.close()).then(function(){var t;return Promise.resolve(null==(t=c)?void 0:t.close()).then(function(){function t(){throw e}var n=U(function(){var e;return Promise.resolve(null==(e=h)?void 0:e.release()).then(function(){h=null})},function(){});return n&&n.then?n.then(t):t()})})})},i=d.getFullOptions(e);i.onStatusChange&&i.onStatusChange({status:"connecting"}),i.onCanSendFeedbackChange&&i.onCanSendFeedbackChange({canSendFeedback:!1});var a=null,s=null,c=null,u=null,l=null==(n=e.useWakeLock)||n,h=null,p=function(){if(l)return Promise.resolve(t.requestWakeLock()).then(function(e){h=e})}();return Promise.resolve(p&&p.then?p.then(r):r())}catch(e){return Promise.reject(e)}};var n=t.prototype;return n.handleEndSession=function(){try{var t=this;return Promise.resolve(e.prototype.handleEndSession.call(t)).then(function(){function e(){return Promise.resolve(t.input.close()).then(function(){return Promise.resolve(t.output.close()).then(function(){})})}t.visibilityChangeHandler&&document.removeEventListener("visibilitychange",t.visibilityChangeHandler);var n=U(function(){var e;return Promise.resolve(null==(e=t.wakeLock)?void 0:e.release()).then(function(){t.wakeLock=null})},function(){});return n&&n.then?n.then(e):e()})}catch(e){return Promise.reject(e)}},n.handleInterruption=function(t){e.prototype.handleInterruption.call(this,t),this.fadeOutAudio()},n.handleAudio=function(t){var n,o;e.prototype.handleAudio.call(this,t),t.audio_event.alignment&&this.options.onAudioAlignment&&this.options.onAudioAlignment(t.audio_event.alignment),this.lastInterruptTimestamp<=t.audio_event.event_id&&(t.audio_event.audio_base_64&&(null==(n=(o=this.options).onAudio)||n.call(o,t.audio_event.audio_base_64),this.connection instanceof R||this.addAudioBase64Chunk(t.audio_event.audio_base_64)),this.currentEventId=t.audio_event.event_id,this.updateCanSendFeedback(),this.updateMode("speaking"))},n.setMicMuted=function(e){this.connection instanceof R?this.connection.setMicMuted(e):this.input.setMuted(e)},n.getInputByteFrequencyData=function(){return null!=this.inputFrequencyData||(this.inputFrequencyData=new Uint8Array(this.input.analyser.frequencyBinCount)),this.input.analyser.getByteFrequencyData(this.inputFrequencyData),this.inputFrequencyData},n.getOutputByteFrequencyData=function(){return this.connection instanceof R?this.connection.getOutputByteFrequencyData()||new Uint8Array(1024):(null!=this.outputFrequencyData||(this.outputFrequencyData=new Uint8Array(this.output.analyser.frequencyBinCount)),this.output.analyser.getByteFrequencyData(this.outputFrequencyData),this.outputFrequencyData)},n.getInputVolume=function(){return this.calculateVolume(this.getInputByteFrequencyData())},n.getOutputVolume=function(){return this.calculateVolume(this.getOutputByteFrequencyData())},n.changeInputDevice=function(e){var t=e.sampleRate,n=e.format,o=e.preferHeadphonesForIosDevices,r=e.inputDeviceId;try{var i,a=this;return Promise.resolve(U(function(){function e(e){if(i)return e;function s(){return Promise.resolve(a.input.close()).then(function(){return Promise.resolve(O.create({sampleRate:null!=t?t:a.connection.inputFormat.sampleRate,format:null!=n?n:a.connection.inputFormat.format,preferHeadphonesForIosDevices:o,inputDeviceId:r,workletPaths:a.options.workletPaths,libsampleratePath:a.options.libsampleratePath,onError:a.options.onError})).then(function(e){return a.input=e,a.input.worklet.port.onmessage=a.onInputWorkletMessage,a.input})})}var c=function(){if(a.connection instanceof R)return Promise.resolve(a.connection.setAudioInputDevice(r||"")).then(function(){})}();return c&&c.then?c.then(s):s()}var s=function(){if(a.connection instanceof y)return U(function(){return Promise.resolve(a.input.setInputDevice(r)).then(function(){return i=1,a.input})},function(e){console.warn("Failed to change device on existing input, recreating:",e)})}();return s&&s.then?s.then(e):e(s)},function(e){throw console.error("Error changing input device",e),e}))}catch(e){return Promise.reject(e)}},n.changeOutputDevice=function(e){var t=e.sampleRate,n=e.format,o=e.outputDeviceId;try{var r,i=this;return Promise.resolve(U(function(){function e(e){if(r)return e;function a(){return Promise.resolve(i.output.close()).then(function(){return Promise.resolve(L.create({sampleRate:null!=t?t:i.connection.outputFormat.sampleRate,format:null!=n?n:i.connection.outputFormat.format,outputDeviceId:o,workletPaths:i.options.workletPaths})).then(function(e){return i.output=e,i.output})})}var s=function(){if(i.connection instanceof R)return Promise.resolve(i.connection.setAudioOutputDevice(o||"")).then(function(){})}();return s&&s.then?s.then(a):a()}var a=function(){if(i.connection instanceof y)return U(function(){return Promise.resolve(i.output.setOutputDevice(o)).then(function(){return r=1,i.output})},function(e){console.warn("Failed to change device on existing output, recreating:",e)})}();return a&&a.then?a.then(e):e(a)},function(e){throw console.error("Error changing output device",e),e}))}catch(e){return Promise.reject(e)}},t}(d),W=/*#__PURE__*/function(){function e(){this.listeners=new Map}var t=e.prototype;return t.on=function(e,t){this.listeners.has(e)||this.listeners.set(e,new Set);var n=this.listeners.get(e);n&&n.add(t)},t.off=function(e,t){var n=this.listeners.get(e);n&&n.delete(t)},t.emit=function(e){var t=arguments,n=this.listeners.get(e);n&&n.forEach(function(e){e.apply(void 0,[].slice.call(t,1))})},e}();e.RealtimeEvents=void 0,(j=e.RealtimeEvents||(e.RealtimeEvents={})).SESSION_STARTED="session_started",j.PARTIAL_TRANSCRIPT="partial_transcript",j.COMMITTED_TRANSCRIPT="committed_transcript",j.COMMITTED_TRANSCRIPT_WITH_TIMESTAMPS="committed_transcript_with_timestamps",j.AUTH_ERROR="auth_error",j.ERROR="error",j.OPEN="open",j.CLOSE="close",j.QUOTA_EXCEEDED="quota_exceeded",j.COMMIT_THROTTLED="commit_throttled",j.TRANSCRIBER_ERROR="transcriber_error",j.UNACCEPTED_TERMS="unaccepted_terms",j.RATE_LIMITED="rate_limited",j.INPUT_ERROR="input_error",j.QUEUE_OVERFLOW="queue_overflow",j.RESOURCE_EXHAUSTED="resource_exhausted",j.SESSION_TIME_LIMIT_EXCEEDED="session_time_limit_exceeded",j.CHUNK_SIZE_EXCEEDED="chunk_size_exceeded",j.INSUFFICIENT_AUDIO_ACTIVITY="insufficient_audio_activity";var q,B,V=/*#__PURE__*/function(){function t(e){this.websocket=null,this.eventEmitter=new W,this.currentSampleRate=16e3,this._audioCleanup=void 0,this.currentSampleRate=e}var n=t.prototype;return n.setWebSocket=function(t){var n=this;this.websocket=t,this.websocket.readyState===WebSocket.OPEN?this.eventEmitter.emit(e.RealtimeEvents.OPEN):this.websocket.addEventListener("open",function(){n.eventEmitter.emit(e.RealtimeEvents.OPEN)}),this.websocket.addEventListener("message",function(t){try{var o=JSON.parse(t.data);switch(o.message_type){case"session_started":n.eventEmitter.emit(e.RealtimeEvents.SESSION_STARTED,o);break;case"partial_transcript":n.eventEmitter.emit(e.RealtimeEvents.PARTIAL_TRANSCRIPT,o);break;case"committed_transcript":n.eventEmitter.emit(e.RealtimeEvents.COMMITTED_TRANSCRIPT,o);break;case"committed_transcript_with_timestamps":n.eventEmitter.emit(e.RealtimeEvents.COMMITTED_TRANSCRIPT_WITH_TIMESTAMPS,o);break;case"auth_error":n.eventEmitter.emit(e.RealtimeEvents.AUTH_ERROR,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"quota_exceeded":n.eventEmitter.emit(e.RealtimeEvents.QUOTA_EXCEEDED,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"commit_throttled":n.eventEmitter.emit(e.RealtimeEvents.COMMIT_THROTTLED,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"transcriber_error":n.eventEmitter.emit(e.RealtimeEvents.TRANSCRIBER_ERROR,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"unaccepted_terms":n.eventEmitter.emit(e.RealtimeEvents.UNACCEPTED_TERMS,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"rate_limited":n.eventEmitter.emit(e.RealtimeEvents.RATE_LIMITED,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"input_error":n.eventEmitter.emit(e.RealtimeEvents.INPUT_ERROR,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"queue_overflow":n.eventEmitter.emit(e.RealtimeEvents.QUEUE_OVERFLOW,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"resource_exhausted":n.eventEmitter.emit(e.RealtimeEvents.RESOURCE_EXHAUSTED,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"session_time_limit_exceeded":n.eventEmitter.emit(e.RealtimeEvents.SESSION_TIME_LIMIT_EXCEEDED,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"chunk_size_exceeded":n.eventEmitter.emit(e.RealtimeEvents.CHUNK_SIZE_EXCEEDED,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"insufficient_audio_activity":n.eventEmitter.emit(e.RealtimeEvents.INSUFFICIENT_AUDIO_ACTIVITY,o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;case"error":n.eventEmitter.emit(e.RealtimeEvents.ERROR,o);break;default:console.warn("Unknown message type:",o)}}catch(o){console.error("Failed to parse WebSocket message:",o,t.data),n.eventEmitter.emit(e.RealtimeEvents.ERROR,new Error("Failed to parse message: "+o))}}),this.websocket.addEventListener("error",function(t){console.error("WebSocket error:",t),n.eventEmitter.emit(e.RealtimeEvents.ERROR,t)}),this.websocket.addEventListener("close",function(t){if(console.log("WebSocket closed: code="+t.code+', reason="'+t.reason+'", wasClean='+t.wasClean),!t.wasClean||1e3!==t.code&&1005!==t.code){var o="WebSocket closed unexpectedly: "+t.code+" - "+(t.reason||"No reason provided");console.error(o),n.eventEmitter.emit(e.RealtimeEvents.ERROR,new Error(o))}n.eventEmitter.emit(e.RealtimeEvents.CLOSE,t)})},n.on=function(e,t){this.eventEmitter.on(e,t)},n.off=function(e,t){this.eventEmitter.off(e,t)},n.send=function(e){var t,n;if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not connected");var o={message_type:"input_audio_chunk",audio_base_64:e.audioBase64,commit:null!=(t=e.commit)&&t,sample_rate:null!=(n=e.sampleRate)?n:this.currentSampleRate,previous_text:e.previousText};this.websocket.send(JSON.stringify(o))},n.commit=function(){if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not connected");this.websocket.send(JSON.stringify({message_type:"input_audio_chunk",audio_base_64:"",commit:!0,sample_rate:this.currentSampleRate}))},n.close=function(){this._audioCleanup&&this._audioCleanup(),this.websocket&&this.websocket.close(1e3,"User ended session")},t}(),H=P("scribeAudioProcessor",'/*\n * Scribe Audio Processor for converting microphone audio to PCM16 format\n * Supports resampling for browsers like Firefox that don\'t support\n * AudioContext sample rate constraints.\n * USED BY @elevenlabs/client\n */\n\nclass ScribeAudioProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n    this.buffer = [];\n    this.bufferSize = 4096; // Buffer size for optimal chunk transmission\n\n    // Resampling state\n    this.inputSampleRate = null;\n    this.outputSampleRate = null;\n    this.resampleRatio = 1;\n    this.lastSample = 0;\n    this.resampleAccumulator = 0;\n\n    this.port.onmessage = ({ data }) => {\n      if (data.type === "configure") {\n        this.inputSampleRate = data.inputSampleRate;\n        this.outputSampleRate = data.outputSampleRate;\n        if (this.inputSampleRate && this.outputSampleRate) {\n          this.resampleRatio = this.inputSampleRate / this.outputSampleRate;\n        }\n      }\n    };\n  }\n\n  // Linear interpolation resampling\n  resample(inputData) {\n    if (this.resampleRatio === 1 || !this.inputSampleRate) {\n      return inputData;\n    }\n\n    const outputSamples = [];\n\n    for (let i = 0; i < inputData.length; i++) {\n      const currentSample = inputData[i];\n\n      // Generate output samples using linear interpolation\n      while (this.resampleAccumulator < 1) {\n        const interpolated =\n          this.lastSample +\n          (currentSample - this.lastSample) * this.resampleAccumulator;\n        outputSamples.push(interpolated);\n        this.resampleAccumulator += this.resampleRatio;\n      }\n\n      this.resampleAccumulator -= 1;\n      this.lastSample = currentSample;\n    }\n\n    return new Float32Array(outputSamples);\n  }\n\n  process(inputs) {\n    const input = inputs[0];\n    if (input.length > 0) {\n      let channelData = input[0]; // Get first channel (mono)\n\n      // Resample if needed (for Firefox and other browsers that don\'t\n      // support AudioContext sample rate constraints)\n      if (this.resampleRatio !== 1) {\n        channelData = this.resample(channelData);\n      }\n\n      // Add incoming audio to buffer\n      for (let i = 0; i < channelData.length; i++) {\n        this.buffer.push(channelData[i]);\n      }\n\n      // When buffer reaches threshold, convert and send\n      if (this.buffer.length >= this.bufferSize) {\n        const float32Array = new Float32Array(this.buffer);\n        const int16Array = new Int16Array(float32Array.length);\n\n        // Convert Float32 [-1, 1] to Int16 [-32768, 32767]\n        for (let i = 0; i < float32Array.length; i++) {\n          // Clamp the value to prevent overflow\n          const sample = Math.max(-1, Math.min(1, float32Array[i]));\n          // Scale to PCM16 range\n          int16Array[i] = sample < 0 ? sample * 32768 : sample * 32767;\n        }\n\n        // Send to main thread as transferable ArrayBuffer\n        this.port.postMessage(\n          {\n            audioData: int16Array.buffer\n          },\n          [int16Array.buffer]\n        );\n\n        // Clear buffer\n        this.buffer = [];\n      }\n    }\n\n    return true; // Continue processing\n  }\n}\n\nregisterProcessor("scribeAudioProcessor", ScribeAudioProcessor);\n\n');e.AudioFormat=void 0,(q=e.AudioFormat||(e.AudioFormat={})).PCM_8000="pcm_8000",q.PCM_16000="pcm_16000",q.PCM_22050="pcm_22050",q.PCM_24000="pcm_24000",q.PCM_44100="pcm_44100",q.PCM_48000="pcm_48000",q.ULAW_8000="ulaw_8000",e.CommitStrategy=void 0,(B=e.CommitStrategy||(e.CommitStrategy={})).MANUAL="manual",B.VAD="vad";var z=/*#__PURE__*/function(){function e(){}return e.getWebSocketUri=function(t){return void 0===t&&(t=e.DEFAULT_BASE_URI),t+"/v1/speech-to-text/realtime"},e.buildWebSocketUri=function(t){var n=e.getWebSocketUri(t.baseUri),o=new URLSearchParams;if(o.append("model_id",t.modelId),o.append("token",t.token),void 0!==t.commitStrategy&&o.append("commit_strategy",t.commitStrategy),void 0!==t.audioFormat&&o.append("audio_format",t.audioFormat),void 0!==t.vadSilenceThresholdSecs){if(t.vadSilenceThresholdSecs<=.3||t.vadSilenceThresholdSecs>3)throw new Error("vadSilenceThresholdSecs must be between 0.3 and 3.0");o.append("vad_silence_threshold_secs",t.vadSilenceThresholdSecs.toString())}if(void 0!==t.vadThreshold){if(t.vadThreshold<.1||t.vadThreshold>.9)throw new Error("vadThreshold must be between 0.1 and 0.9");o.append("vad_threshold",t.vadThreshold.toString())}if(void 0!==t.minSpeechDurationMs){if(t.minSpeechDurationMs<=50||t.minSpeechDurationMs>2e3)throw new Error("minSpeechDurationMs must be between 50 and 2000");o.append("min_speech_duration_ms",t.minSpeechDurationMs.toString())}if(void 0!==t.minSilenceDurationMs){if(t.minSilenceDurationMs<=50||t.minSilenceDurationMs>2e3)throw new Error("minSilenceDurationMs must be between 50 and 2000");o.append("min_silence_duration_ms",t.minSilenceDurationMs.toString())}void 0!==t.languageCode&&o.append("language_code",t.languageCode),void 0!==t.includeTimestamps&&o.append("include_timestamps",t.includeTimestamps?"true":"false");var r=o.toString();return r?n+"?"+r:n},e.connect=function(t){if(!t.modelId)throw new Error("modelId is required");var n=new V("microphone"in t&&t.microphone?16e3:t.sampleRate),o=e.buildWebSocketUri(t),r=new WebSocket(o);return"microphone"in t&&t.microphone&&r.addEventListener("open",function(){e.streamFromMicrophone(t,n)}),n.setWebSocket(r),n},e.streamFromMicrophone=function(e,t){try{var n=16e3;return Promise.resolve(function(o,r){try{var i=Promise.resolve(navigator.mediaDevices.getUserMedia({audio:{deviceId:null==(a=e.microphone)?void 0:a.deviceId,echoCancellation:null==(s=null==(c=e.microphone)?void 0:c.echoCancellation)||s,noiseSuppression:null==(u=null==(l=e.microphone)?void 0:l.noiseSuppression)||u,autoGainControl:null==(d=null==(h=e.microphone)?void 0:h.autoGainControl)||d,channelCount:null!=(p=null==(m=e.microphone)?void 0:m.channelCount)?p:1,sampleRate:{ideal:n}}})).then(function(e){var o,r=null==(o=e.getAudioTracks()[0])?void 0:o.getSettings(),i=null==r?void 0:r.sampleRate,a=new AudioContext(i?{sampleRate:i}:{});return Promise.resolve(H(a.audioWorklet)).then(function(){function o(){t._audioCleanup=function(){e.getTracks().forEach(function(e){e.stop()}),r.disconnect(),i.disconnect(),a.close()}}var r=a.createMediaStreamSource(e),i=new AudioWorkletNode(a,"scribeAudioProcessor");a.sampleRate!==n&&i.port.postMessage({type:"configure",inputSampleRate:a.sampleRate,outputSampleRate:n}),i.port.onmessage=function(e){for(var n=new Uint8Array(e.data.audioData),o="",r=0;r<n.length;r++)o+=String.fromCharCode(n[r]);var i=btoa(o);t.send({audioBase64:i})},r.connect(i);var s=function(){if("suspended"===a.state)return Promise.resolve(a.resume()).then(function(){})}();return s&&s.then?s.then(o):o()})})}catch(e){return r(e)}var a,s,c,u,l,d,h,p,m;return i&&i.then?i.then(void 0,r):i}(0,function(e){throw console.error("Failed to start microphone streaming:",e),e}))}catch(e){return Promise.reject(e)}},e}();z.DEFAULT_BASE_URI="wss://api.elevenlabs.io";var J=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return i(t,e),t.startSession=function(e){var n=t.getFullOptions(e);return n.textOnly?T.startSession(n):N.startSession(n)},t}(d);e.Conversation=J,e.Input=O,e.Output=L,e.RealtimeConnection=V,e.Scribe=z,e.SessionConnectionError=_,e.TextConversation=T,e.VoiceConversation=N,e.WebRTCConnection=R,e.WebSocketConnection=y,e.createConnection=I,e.postOverallFeedback=function(e,t,n){void 0===n&&(n="https://api.elevenlabs.io");var o={};return"boolean"==typeof t?o.feedback=t?"like":"dislike":(o.rating=t.rating,o.comment=t.comment),fetch(n+"/v1/convai/conversations/"+e+"/feedback",{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}})}});
//# sourceMappingURL=lib.umd.js.map
